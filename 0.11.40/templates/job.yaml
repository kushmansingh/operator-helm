apiVersion: batch/v1
kind: Job
metadata:
  creationTimestamp: null
  name: speedscale-keys-create
  namespace: speedscale
spec:
  template:
    metadata:
      creationTimestamp: null
    spec:
      containers:
      - command:
        - /bin/sh
        - -ce
        - |
          speedctl init --force --api-key {{ .Values.apiKey }} --app-url {{ .Values.appUrl }}
          speedctl deploy operator --dir ./manifests \
            || (echo 'speedctl init failed, verify API_KEY is correct' && exit 1)
          kubectl apply -f ./manifests/webhook.yaml
          kubectl apply -f ./manifests/configmap.yaml
          kubectl apply -f ./manifests/secret.yaml
        image: gcr.io/sspublic/speedscale-cli:0.11.40
        imagePullPolicy: Always
        name: speedscale-cli
        resources: {}
      restartPolicy: Never
      serviceAccountName: speedscale-control-sa
status: {}
---
apiVersion: batch/v1
kind: Job
metadata:
  annotations:
    helm.sh/hook: pre-delete
  creationTimestamp: null
  name: speedscale-keys-cleanup
  namespace: speedscale
spec:
  template:
    metadata:
      creationTimestamp: null
    spec:
      containers:
      - command:
        - /bin/sh
        - -ce
        - |
          speedctl init --force --api-key {{ .Values.apiKey }} --app-url {{ .Values.appUrl }} \
            || (echo 'speedctl init failed, quitting' && exit 0) # don't let the cleanup job fail or helm won't uninstall properly
          speedctl deploy operator --dir ./manifests
          kubectl delete -f ./manifests/webhook.yaml
        image: gcr.io/sspublic/speedscale-cli:0.11.40
        imagePullPolicy: Always
        name: speedscale-cli
        resources: {}
      restartPolicy: Never
      serviceAccountName: speedscale-control-sa
status: {}
